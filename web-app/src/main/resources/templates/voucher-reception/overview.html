<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
</head>

<body>
<main layout:fragment="content">
    <div class="wa-container">
        <div class="wa-stack wa-gap-s">
            <div>
                <h1 class="wa-heading-l" th:text="#{voucher_reception}">Voucher Reception</h1>
                <p class="wa-body-m" th:text="#{voucher_reception_info}">ðŸ“± Drag and drop your files directly on this page or send them to</p>
                <p class="wa-body-s" th:if="${tenantSlug != null}" th:text="'ðŸ“§ ' + ${tenantSlug} + '@reai.no'"></p>
            </div>

            <wa-card>
                <div slot="header" class="wa-split">
                    <h4>Uploaded Documents</h4>
                    <wa-button size="small" variant="neutral"
                               th:hx-get="@{/htmx/voucher-reception/refresh-table}"
                               th:hx-target=".wa-card__body"
                               th:hx-swap="innerHTML">
                        <wa-icon slot="prefix" name="arrow-clockwise" size="small"></wa-icon>
                        Refresh
                    </wa-button>
                </div>
                <div class="wa-card__body" th:fragment="table">
                    <table class="r-voucher-reception-table">
                        <thead>
                        <tr>
                            <th th:text="#{filename}" />
                            <th th:text="#{sender_email}" />
                            <th th:text="#{mime_type}" />
                            <th th:text="#{received}" />
                            <th th:text="#{file_created_at}" />
                            <th>AI Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="document : ${documents}">
                            <td th:text="${document.attachment.filename}"/>
                            <td th:text="${document.senderEmail ?: '-'}"/>
                            <td th:text="${document.attachment.mimetype}"/>
                            <td th:text="${#temporals.format(document.receivedAt, 'dd.MM.yyyy HH:mm')}"/>
                            <td th:text="${#temporals.format(document.attachment.createdAt, 'dd.MM.yyyy HH:mm')}"/>
                            <td>
                                <wa-badge th:if="${document.aiExtraction != null}"
                                          th:attr="variant=${document.aiExtraction.status?.name?.toLowerCase()}"
                                          th:text="${document.aiExtraction.status == 'CONVERTED_TO_VOUCHER' ? 'VOUCHER CREATED' : document.aiExtraction.status ?: 'NOT_PROCESSED'}"/>
                                <span th:unless="${document.aiExtraction != null}">-</span>
                            </td>
                            <td>
                                <div class="wa-cluster wa-gap-xs">
                                    <wa-button th:if="${document.aiExtraction?.status == 'COMPLETED'}"
                                               size="small" variant="brand"
                                               th:hx-get="@{/htmx/voucher-reception/show-extraction(documentId=${document.id})}"
                                               th:hx-target="#extraction-modal"
                                               th:hx-swap="innerHTML">
                                        View Data
                                    </wa-button>
                                    <wa-button th:if="${document.aiExtraction?.status == 'COMPLETED'}"
                                               size="small" variant="success"
                                               th:hx-post="@{/htmx/voucher-reception/create-voucher(extractionId=${document.aiExtraction.id})}"
                                               th:hx-target="body"
                                               th:hx-swap="beforeend">
                                        Create Voucher
                                    </wa-button>
                                    <wa-badge th:if="${document.aiExtraction?.status == 'CONVERTED_TO_VOUCHER'}"
                                             variant="success" size="small">
                                        <wa-icon slot="prefix" name="check" size="small"></wa-icon>
                                        Auto-Created
                                    </wa-badge>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="wa-center" th:if="${#lists.isEmpty(documents)}">
                        <div class="wa-stack wa-center wa-gap-m">
                            <wa-icon name="document-text" style="font-size: 3rem; opacity: 0.5;"></wa-icon>
                            <h2 class="wa-heading-m" th:text="#{no_voucher_reception_found}" />
                        </div>
                    </div>
                </div>
            </wa-card>
        </div>
    </div>
    
    <!-- AI Extraction Modal -->
    <div id="extraction-modal"></div>
</main>

<script>
// Auto-refresh table after voucher creation
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.responseURL && event.detail.xhr.responseURL.includes('/create-voucher')) {
        // Wait a moment for the database to update, then refresh the table
        setTimeout(function() {
            htmx.ajax('GET', '/htmx/voucher-reception/refresh-table', {
                target: '.wa-card__body',
                swap: 'innerHTML'
            });
        }, 1000);
    }
});

// Auto-refresh table every 30 seconds to show AI processing status
setInterval(function() {
    htmx.ajax('GET', '/htmx/voucher-reception/refresh-table', {
        target: '.wa-card__body',
        swap: 'innerHTML'
    });
}, 30000);
</script>
</body>
</html>