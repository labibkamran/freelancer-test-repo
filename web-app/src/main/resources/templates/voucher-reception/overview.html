<!DOCTYPE html>
<html dir="ltr" lang="en" layout:decorate="~{layout/base}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" th:href="@{/assets/voucher/voucher-reception.css}">
</head>
<body>
<main layout:fragment="content">
    <div class="r-voucher-reception-container">
        <wa-callout variant="neutral" class="r-voucher-reception">
            <h1 class="wa-heading-xl" th:text="#{voucher_reception}"/>
            <p class="wa-text">
                <span th:text="#{voucher_reception_info}"/>
                <wa-tag variant="brand" appearance="accent">
                    <span th:text="${tenantSlug + '@ea.reai.no'}"/>
                    <wa-copy-button th:value="${tenantSlug + '@ea.reai.no'}"></wa-copy-button>
                </wa-tag>
            </p>
        </wa-callout>

        <div style="overflow-x: auto;">
            <table class="r-voucher-reception-table">
                <thead>
                <tr>
                    <th th:text="#{filename}"/>
                    <th th:text="#{sender_email}"/>
                    <th th:text="#{mime_type}"/>
                    <th th:text="#{received}"/>
                    <th th:text="#{file_created_at}"/>
                    <th th:text="action"/>
                </tr>
                </thead>
                <tbody>
                <tr th:each="document : ${documents}">
                    <td th:text="${document.attachment.filename}"/>
                    <td th:text="${document.senderEmail ?: '-'}"/>
                    <td th:text="${document.attachment.mimetype}"/>
                    <td th:text="${#temporals.format(document.receivedAt, 'dd.MM.yyyy HH:mm')}"/>
                    <td th:text="${#temporals.format(document.attachment.createdAt, 'dd.MM.yyyy HH:mm')}"/>
                    <td>
                        <wa-button
                                data-drawer="open drawer-custom-size"
                                variant="outline"
                                size="small"
                                class="view-pdf-btn"
                                th:data-document-id="${document.id}"
                                th:data-filename="${document.attachment.filename}"
                                th:data-pdf-data="${pdfDataMap[document.id]}">
                            <wa-icon name="eye"></wa-icon>
                            View PDF
                        </wa-button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="wa-center" th:if="${#lists.isEmpty(documents)}">
                <div class="wa-stack wa-center wa-gap-m">
                    <wa-icon name="document-text" style="font-size: 3rem; opacity: 0.5;"></wa-icon>
                    <h2 class="wa-heading-m" th:text="#{no_voucher_reception_found}"/>
                </div>
            </div>
        </div>

        <!-- PDF Preview Drawer -->
        <wa-drawer id="drawer-custom-size" class="drawer-custom-size" style="--size: 45vw; --spacing: 0">
            <button class="hide-attachment-button" onclick="drawer.close()">
                <i class="fas fa-chevron-left"></i> Hide attachment
            </button>
            <div id="pdf-container" style="height: 100%; overflow-y: hidden;">
                <embed id="pdf-embed" type="application/pdf" style="width: 100%; height: 100%; border: none;"/>
            </div>
        </wa-drawer>


        <script>
            const drawer = document.querySelector('.drawer-custom-size');
            const pdfEmbed = document.getElementById('pdf-embed');

            let currentPdfUrl = null;

            document.querySelectorAll('.view-pdf-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const base64 = this.dataset.pdfData;
                    const binary = atob(base64);
                    const len = binary.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    const blob = new Blob([bytes], {type: 'application/pdf'});
                    if (currentPdfUrl) URL.revokeObjectURL(currentPdfUrl);
                    currentPdfUrl = URL.createObjectURL(blob);

                    pdfEmbed.src = currentPdfUrl;
                    drawer.open = true;
                });
            });

            drawer.addEventListener('wa-close', () => {
                if (currentPdfUrl) {
                    URL.revokeObjectURL(currentPdfUrl);
                    currentPdfUrl = null;
                }
                pdfEmbed.removeAttribute('src');
            });
        </script>
    </div>
</main>
</body>
</html>