<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      class="wa-cloak wa-theme-matter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title != null ? title + ' - Reai' : 'Reai'}">Reai</title>

    <!-- Web Awesome -->
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/themes/default.css"/>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/webawesome.css"/>
    <script type="module" src="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/webawesome.loader.js"></script>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/themes/matter.css"/>

    <!-- HTMX Latest -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>

    <!-- Custom head content -->
    <th:block layout:fragment="head"></th:block>
</head>
<body>
<!-- Authenticated User Layout -->
<wa-page mobile-breakpoint="920" th:if="${user != null}">
    <!-- Header -->
    <header slot="header" class="wa-split">
        <div class="wa-cluster">
            <span class="wa-heading-s wa-desktop-only">Reai - Accounting System</span>
            <!-- Company Selector -->
            <wa-dropdown>
                <wa-button slot="trigger" size="small" variant="brand" appearance="outlined" with-caret
                           th:text="${currentCompany != null ? currentCompany.name : 'Select Company'}">
                    Select Company
                </wa-button>
                <wa-dropdown-item th:each="company : ${companies}"
                                  th:onclick="'switchCompany(' + ${company.tenantId} + ')'"
                                  th:class="${currentCompany != null and currentCompany.tenantId == company.tenantId} ? 'selected' : ''">
                    <span th:text="${company.name}">Company Name</span>
                </wa-dropdown-item>
                <wa-divider></wa-divider>
                <wa-dropdown-item onclick="window.open('/company/create', '_blank')">
                    <wa-icon slot="icon" name="plus"></wa-icon>
                    <span>Create New Company</span>
                </wa-dropdown-item>
            </wa-dropdown>
        </div>
        <div class="wa-cluster wa-gap-xs">
            <!-- User Menu -->
            <wa-dropdown>
                <wa-button slot="trigger" size="small" variant="brand" with-caret>
                    <wa-icon slot="prefix" name="user"></wa-icon>
                    <th:block th:text="${user.username}"></th:block>
                </wa-button>
                <wa-dropdown-item onclick="window.location.href='/auth/logout'" variant="danger">
                    <wa-icon slot="icon" name="arrow-right-from-bracket"></wa-icon>
                    Logout
                </wa-dropdown-item>
            </wa-dropdown>
        </div>
    </header>

    <!-- Subheader with breadcrumbs -->
    <nav slot="subheader">
        <div class="wa-cluster" style="flex-wrap: nowrap">
            <wa-button data-toggle-nav appearance="plain" size="small">
                <wa-icon name="bars" label="Menu"></wa-icon>
            </wa-button>
            <wa-breadcrumb style="font-size: var(--wa-font-size-s)">
                <wa-breadcrumb-item>Dashboard</wa-breadcrumb-item>
                <wa-breadcrumb-item th:if="${currentCompany != null}" th:text="${currentCompany.name}">Company
                </wa-breadcrumb-item>
            </wa-breadcrumb>
        </div>
    </nav>

    <!-- Navigation -->
    <nav slot="navigation">
        <th:block th:if="${user.ctx.currentTenant != null}">
            <!-- Dashboard -->
            <wa-details appearance="outlined" variant="brand">
                <div slot="summary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <wa-icon name="dashboard" aria-hidden="true"></wa-icon>
                    Dashboard
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li class="wa-body-s">
                        <a th:href="'/dashboard?tenantId=' + ${user.ctx.currentTenant.id}"
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;">
                            Home
                        </a>
                    </li>
                </ul>
            </wa-details>

            <!-- Vouchers Section -->
            <wa-details appearance="outlined" variant="success">
                <div slot="summary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <wa-icon name="file-text" aria-hidden="true"></wa-icon>
                    Vouchers
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li class="wa-body-s">
                        <a th:href="'/voucher/new-advanced-voucher?tenantId=' + ${user.ctx.currentTenant.id}"
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;">
                            New Advanced Voucher
                        </a>
                    </li>
                </ul>
            </wa-details>

            <!-- Reports Section -->
            <wa-details appearance="outlined" variant="info">
                <div slot="summary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <wa-icon name="chart-simple" aria-hidden="true"></wa-icon>
                    Reports
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li class="wa-body-s">
                        <a th:href="'/report/trial-balance?tenantId=' + ${user.ctx.currentTenant.id}"
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;">
                            Trial Balance
                        </a>
                    </li>
                </ul>
            </wa-details>
        </th:block>
    </nav>

    <!-- Navigation Footer -->
   <!-- <nav slot="navigation-footer">
        <a href="/company/create" class="wa-flank">
            <wa-icon name="building"></wa-icon>
            <span>Create Company</span>
        </a>
    </nav>-->

    <!-- Aside Sidebar -->
    <aside slot="aside" class="wa-desktop-only" th:if="${user.ctx.currentTenant != null}" id="aside-panel">
        <div layout:fragment="aside" id="aside-content">
            <!-- Aside content will be inserted here -->
        </div>
    </aside>

    <!-- Main Content -->
    <main layout:fragment="content" id="main-content">
        <!-- Page content will be inserted here -->
    </main>

    <!-- Footer -->
    <footer slot="footer" class="wa-grid wa-gap-xl">
        <div class="wa-cluster" style="flex-wrap: nowrap">
            <span class="wa-heading-s">Reai - Accounting System</span>
        </div>
        <div class="wa-stack">
            <h3 class="wa-heading-xs">Account</h3>
            <a href="/auth/logout">Logout</a>
        </div>
        <div class="wa-stack">
            <span class="wa-body-s">Â© 2025 - Accounting System</span>
        </div>
    </footer>
</wa-page>

<!-- Non-authenticated User Layout -->
<div th:if="${user == null}" class="wa-center"
     style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <main layout:fragment="content">
        <!-- Auth page content will be inserted here -->
    </main>
</div>

<!-- HTMX Extensions -->
<script src="https://unpkg.com/htmx.org/dist/ext/loading-states.js"></script>

<!-- Custom JS -->
<script>
    // HTMX Configuration
    htmx.config.globalViewTransitions = true;

    // Company switching function
    function switchCompany(tenantId) {
        const dashboardUrl = new URL('/dashboard', window.location.origin);
        dashboardUrl.searchParams.set('tenantId', tenantId);
        window.open(dashboardUrl.toString(), '_blank');
    }

    // Get current tenant ID from URL
    function getCurrentTenantId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('tenantId');
    }

    // Show loading states
    document.addEventListener('htmx:beforeRequest', function (evt) {
        const target = evt.target;
        if (target.tagName === 'WA-BUTTON') {
            target.loading = true;
        }
    });

    document.addEventListener('htmx:afterRequest', function (evt) {
        const target = evt.target;
        if (target.tagName === 'WA-BUTTON') {
            target.loading = false;
        }
    });

    // Auto-hide success alerts after 5 seconds
    setTimeout(function () {
        const alerts = document.querySelectorAll('wa-alert[variant="success"]');
        alerts.forEach(function (alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);

    // Handle navigation
    document.addEventListener('DOMContentLoaded', function () {
        // Close drawer on navigation link click (mobile)
        const navigationLinks = document.querySelectorAll("[slot='navigation'] a[href]:not([href='#'])");
        navigationLinks.forEach(link => {
            link.addEventListener('click', function () {
                // Close mobile navigation drawer
                const page = document.querySelector('wa-page');
                if (page && page.getAttribute('view') === 'mobile') {
                    page.setAttribute('drawer', 'closed');
                }
            });
        });

        // Handle section anchors
        const sectionAnchors = document.querySelectorAll("[slot*='navigation'] a[href*='#']");
        sectionAnchors.forEach(sectionAnchor => sectionAnchor.setAttribute('data-drawer', 'close'));
    });

    // Handle aside visibility based on content
    document.addEventListener('DOMContentLoaded', function () {
        const asideContent = document.getElementById('aside-content');
        const page = document.querySelector('wa-page');

        function updateAsideVisibility() {
            if (!asideContent || !page) return;

            const hasContent = asideContent.textContent.trim().length > 0 || asideContent.children.length > 0;

            if (hasContent) {
                page.setAttribute('data-aside-visible', 'true');
            } else {
                page.setAttribute('data-aside-visible', 'false');
            }
        }

        // Check on load
        updateAsideVisibility();

        // Check after HTMX requests
        document.addEventListener('htmx:afterSettle', updateAsideVisibility);
    });
</script>

<!-- Page styling -->
<style>
    wa-page {
        --menu-width: 15rem;
        --aside-width: 15rem;
    }

    wa-page[view='desktop'] {
        [slot*='navigation'] {
            border-inline-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
        }
    }

    wa-page[view='mobile'] {
        --menu-width: auto;
        --aside-width: auto;
    }

    [slot='header'] {
        --wa-link-decoration-default: none;
        border-block-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
    }

    [slot*='header'] a {
        font-weight: var(--wa-font-weight-action);
    }

    [slot='subheader'] {
        background-color: var(--wa-color-surface-lowered);
        border-block-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
    }

    [slot='navigation-footer'] {
        border-block-start: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);

        .wa-flank {
            --flank-size: 1.25em;
        }
    }

    main {
        max-inline-size: 60rem;
        margin-inline: auto;
        padding: var(--wa-space-l);
    }

    [slot='footer'] {
        --wa-color-text-link: var(--wa-color-text-quiet);
        background-color: var(--wa-color-surface-lowered);
        font-size: var(--wa-font-size-s);
    }

    /* Auth layout styling */
    .wa-center main {
        max-width: 400px;
        width: 100%;
        padding: var(--wa-space-xl);
    }

    /* Dynamic aside width based on content */
    wa-page[data-aside-visible="false"] {
        --aside-width: 0;
    }

    wa-page[data-aside-visible="true"] {
        --aside-width: 15rem;
    }

    /* Hide aside when empty */
    wa-page[data-aside-visible="false"] [slot="aside"] {
        display: none;
    }

    /* Expand main content when aside is hidden */
    wa-page[data-aside-visible="false"] main {
        max-inline-size: 80rem;
    }
</style>

<!-- Custom scripts -->
<th:block layout:fragment="scripts"></th:block>
</body>
</html>