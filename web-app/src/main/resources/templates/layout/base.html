<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" class="wa-cloak wa-theme-matter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title != null ? title + ' - Reai' : 'Reai'}">Reai</title>

    <!-- Web Awesome -->
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/themes/default.css" />
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/webawesome.css" />
    <script type="module" src="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/webawesome.loader.js"></script>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.1/dist/styles/themes/matter.css" />

    <!-- HTMX Latest -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>

    <!-- Custom head content -->
    <th:block layout:fragment="head"></th:block>
</head>
<body>
<!-- Authenticated User Layout -->
<wa-page mobile-breakpoint="920" th:if="${user != null}">
    <!-- Header -->
    <header slot="header" class="wa-split">
        <div class="wa-cluster">
            <span class="wa-heading-s wa-desktop-only">Reai - Accounting System</span>
            <!-- Company Selector -->
            <wa-dropdown>
                <wa-button slot="trigger" size="small" variant="brand" appearance="outlined" with-caret
                           th:text="${currentCompany != null ? currentCompany.name : 'Select Company'}">
                    Select Company
                </wa-button>
                <wa-dropdown-item th:each="company : ${companies}"
                                  th:onclick="'switchCompany(' + ${company.tenantId} + ')'"
                                  th:class="${currentCompany != null and currentCompany.tenantId == company.tenantId} ? 'selected' : ''">
                    <span th:text="${company.name}">Company Name</span>
                </wa-dropdown-item>
                <wa-divider></wa-divider>
                <wa-dropdown-item onclick="window.open('/company/create', '_blank')">
                    <wa-icon slot="icon" name="plus"></wa-icon>
                    <span>Create New Company</span>
                </wa-dropdown-item>
            </wa-dropdown>
        </div>
        <div class="wa-cluster wa-gap-xs">
            <!-- User Menu -->
            <wa-dropdown>
                <wa-button slot="trigger" size="small" variant="brand" with-caret>
                    <wa-icon slot="prefix" name="user"></wa-icon>
                    <th:block th:text="${user.username}"></th:block>
                </wa-button>
                <wa-dropdown-item onclick="window.location.href='/auth/logout'" variant="danger">
                    <wa-icon slot="icon" name="arrow-right-from-bracket"></wa-icon>
                    Logout
                </wa-dropdown-item>
            </wa-dropdown>
        </div>
    </header>

    <!-- Subheader with breadcrumbs -->
    <nav slot="subheader">
        <div class="wa-cluster" style="flex-wrap: nowrap">
            <wa-button data-toggle-nav appearance="plain" size="small">
                <wa-icon name="bars" label="Menu"></wa-icon>
            </wa-button>
            <wa-breadcrumb style="font-size: var(--wa-font-size-s)">
                <wa-breadcrumb-item>Dashboard</wa-breadcrumb-item>
                <wa-breadcrumb-item th:if="${currentCompany != null}" th:text="${currentCompany.name}">Company</wa-breadcrumb-item>
            </wa-breadcrumb>
        </div>
    </nav>

    <!-- Navigation -->
    <nav slot="navigation">
        <wa-tree class="navigation-tree">
            <!-- Dashboard -->
            <wa-tree-item>
                <wa-icon name="house"></wa-icon>
                <a href="/dashboard" style="text-decoration: none; color: inherit;">Home</a>
            </wa-tree-item>

            <th:block th:if="${user.ctx.currentTenant != null}">
                <!-- Vouchers Section -->
                <wa-tree-item>
                    <wa-icon name="file-text"></wa-icon>
                    Vouchers
                    <wa-tree-item>
                        <wa-icon name="plus"></wa-icon>
                        <a th:href="'/voucher/new-advanced-voucher?tenantId=' + ${user.ctx.currentTenant.id}" 
                           style="text-decoration: none; color: inherit;">Create Advanced Voucher</a>
                    </wa-tree-item>
                    <wa-tree-item>
                        <wa-icon name="list"></wa-icon>
                        <a href="#" style="text-decoration: none; color: inherit;">View Vouchers</a>
                    </wa-tree-item>
                </wa-tree-item>

                <!-- Reports Section -->
                <wa-tree-item>
                    <wa-icon name="chart-simple"></wa-icon>
                    Reports
                    <wa-tree-item>
                        <wa-icon name="scale-balanced"></wa-icon>
                        <a th:href="'/report/trial-balance?tenantId=' + ${user.ctx.currentTenant.id}" 
                           style="text-decoration: none; color: inherit;">Trial Balance</a>
                    </wa-tree-item>
                    <wa-tree-item>
                        <wa-icon name="chart-line"></wa-icon>
                        <a href="#" style="text-decoration: none; color: inherit;">Profit & Loss</a>
                    </wa-tree-item>
                    <wa-tree-item>
                        <wa-icon name="chart-pie"></wa-icon>
                        <a href="#" style="text-decoration: none; color: inherit;">Balance Sheet</a>
                    </wa-tree-item>
                </wa-tree-item>
            </th:block>

        </wa-tree>
    </nav>

    <!-- Navigation Footer -->
    <!--<nav slot="navigation-footer">
        <a href="/company/create" class="wa-flank">
            <wa-icon name="building"></wa-icon>
            <span>Create Company</span>
        </a>
    </nav>-->

    <!-- Main Content -->
    <main layout:fragment="content">
        <!-- Page content will be inserted here -->
    </main>

    <!-- Footer -->
    <footer slot="footer" class="wa-grid wa-gap-xl">
        <div class="wa-cluster" style="flex-wrap: nowrap">
            <span class="wa-heading-s">Reai - Accounting System</span>
        </div>
        <div class="wa-stack">
            <h3 class="wa-heading-xs">Account</h3>
            <a href="/auth/logout">Logout</a>
        </div>
        <div class="wa-stack">
            <span class="wa-body-s">Â© 2025 - Accounting System</span>
        </div>
    </footer>
</wa-page>

<!-- Non-authenticated User Layout -->
<div th:if="${user == null}" class="wa-center" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <main layout:fragment="content">
        <!-- Auth page content will be inserted here -->
    </main>
</div>

<!-- HTMX Extensions -->
<script src="https://unpkg.com/htmx.org/dist/ext/loading-states.js"></script>

<!-- Custom JS -->
<script>
    // HTMX Configuration
    htmx.config.globalViewTransitions = true;

    // Company switching function
    function switchCompany(tenantId) {
        const dashboardUrl = new URL('/dashboard', window.location.origin);
        dashboardUrl.searchParams.set('tenantId', tenantId);
        window.open(dashboardUrl.toString(), '_blank');
    }

    // Get current tenant ID from URL
    function getCurrentTenantId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('tenantId');
    }

    // Show loading states
    document.addEventListener('htmx:beforeRequest', function(evt) {
        const target = evt.target;
        if (target.tagName === 'WA-BUTTON') {
            target.loading = true;
        }
    });

    document.addEventListener('htmx:afterRequest', function(evt) {
        const target = evt.target;
        if (target.tagName === 'WA-BUTTON') {
            target.loading = false;
        }
    });

    // Auto-hide success alerts after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('wa-alert[variant="success"]');
        alerts.forEach(function(alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);

    // Handle navigation tree
    document.addEventListener('DOMContentLoaded', function() {
        // Close drawer on navigation link click (mobile)
        const navigationLinks = document.querySelectorAll(".navigation-tree a[href]:not([href='#'])");
        navigationLinks.forEach(link => {
            link.addEventListener('click', function() {
                // Close mobile navigation drawer
                const page = document.querySelector('wa-page');
                if (page && page.getAttribute('view') === 'mobile') {
                    page.setAttribute('drawer', 'closed');
                }
            });
        });

        // Handle section anchors
        const sectionAnchors = document.querySelectorAll("[slot*='navigation'] a[href*='#']");
        sectionAnchors.forEach(sectionAnchor => sectionAnchor.setAttribute('data-drawer', 'close'));
    });
</script>

<!-- Page styling -->
<style>
    wa-page {
        --menu-width: 15rem;
        --aside-width: 15rem;
    }

    wa-page[view='desktop'] {
        [slot*='navigation'] {
            border-inline-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
        }
    }

    wa-page[view='mobile'] {
        --menu-width: auto;
        --aside-width: auto;
    }

    [slot='header'] {
        --wa-link-decoration-default: none;
        border-block-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
    }

    [slot*='header'] a {
        font-weight: var(--wa-font-weight-action);
    }

    [slot='subheader'] {
        background-color: var(--wa-color-surface-lowered);
        border-block-end: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);
    }

    /* Navigation Tree Styling */
    .navigation-tree {
        font-size: var(--wa-font-size-s);
        padding: var(--wa-space-s);
    }

    .navigation-tree wa-tree-item {
        --tree-item-padding: var(--wa-space-xs) var(--wa-space-s);
        margin-bottom: var(--wa-space-2xs);
    }

    .navigation-tree wa-tree-item wa-icon {
        margin-right: var(--wa-space-xs);
        font-size: var(--wa-font-size-s);
    }

    .navigation-tree wa-tree-item > wa-tree-item {
        font-size: var(--wa-font-size-xs);
        margin-left: var(--wa-space-m);
    }

    .navigation-tree a {
        color: inherit;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        width: 100%;
        padding: var(--wa-space-2xs) 0;
        border-radius: var(--wa-border-radius-s);
        transition: background-color 0.2s ease;
    }

    .navigation-tree a:hover {
        background-color: var(--wa-color-surface-lowered);
        padding-left: var(--wa-space-xs);
    }

    [slot='navigation-footer'] {
        border-block-start: var(--wa-border-width-s) var(--wa-border-style) var(--wa-color-surface-border);

        .wa-flank {
            --flank-size: 1.25em;
        }
    }

    main {
        max-inline-size: 60rem;
        margin-inline: auto;
        padding: var(--wa-space-l);
    }

    [slot='footer'] {
        --wa-color-text-link: var(--wa-color-text-quiet);
        background-color: var(--wa-color-surface-lowered);
        font-size: var(--wa-font-size-s);
    }

    /* Auth layout styling */
    .wa-center main {
        max-width: 400px;
        width: 100%;
        padding: var(--wa-space-xl);
    }
</style>

<!-- Custom scripts -->
<th:block layout:fragment="scripts"></th:block>
</body>
</html>