<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <style>
        .posting-form {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .balance-row {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .balance-row td {
            padding: 0.5rem 0.4rem;
            font-weight: 500;
        }
        
        .balance-total {
            text-align: right;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .balance-error {
            color: #dc2626 !important;
        }
        
        .balance-success {
            color: #16a34a !important;
        }
        
        .converted-amount {
            font-size: 0.7rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 2px;
        }
        
        .posting-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .posting-table th {
            background: #f8f9fa;
            padding: 0.5rem;
            text-align: left;
            border: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .posting-table td {
            padding: 0.4rem;
            border: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .posting-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .posting-line-row input,
        .posting-line-row select {
            width: 100%;
            border: none;
            background: transparent;
            padding: 0.2rem;
            font-size: 0.85rem;
        }
        
        .posting-line-row input:focus,
        .posting-line-row select:focus {
            outline: 1px solid #3b82f6;
            outline-offset: -1px;
            border-radius: 3px;
        }
        
        .posting-line-row input:disabled {
            background-color: #f5f5f5;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .currency-select {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .amount-input {
            text-align: right;
            font-size: 0.85rem;
        }
        
        .balance-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .balance-item {
            text-align: center;
        }
        
        .balance-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .balance-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .balance-matched {
            color: #16a34a;
        }
        
        .balance-unmatched {
            color: #dc2626;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .account-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .account-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .account-item:hover {
            background-color: #f8fafc;
        }
        
        .account-search {
            position: relative;
        }
        

        
        .htmx-indicator {
            opacity: 0;
            transition: opacity 500ms ease-in;
        }
        
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        
        .field-error {
            border: 2px solid #dc2626 !important;
            background-color: #fef2f2 !important;
        }
        
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        .vat-field {
            font-size: 0.75rem !important;
            color: #374151 !important;
            background: #f8f9fa !important;
            border: 1px solid #e9ecef !important;
            border-radius: 3px;
            padding: 2px 4px !important;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .vat-field:focus {
            outline: 1px solid #3b82f6 !important;
            outline-offset: -1px;
            border-color: #3b82f6 !important;
            background: white !important;
        }
        
        .vat-field:hover {
            background: #e9ecef !important;
            border-color: #ced4da !important;
        }
        
        .vat-field:disabled {
            background-color: #f5f5f5 !important;
            color: #9ca3af !important;
            cursor: not-allowed;
        }
        
        .vat-field::placeholder {
            color: #9ca3af !important;
            font-style: italic;
        }
    </style>
</head>

<body>
<main layout:fragment="content">
    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="h3 mb-2">Register advanced voucher</h2>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="form-messages">
        <div th:if="${successMessage}" class="alert alert-success">
            <wa-icon name="check-circle" style="margin-right: 0.5rem;"></wa-icon>
            <span th:text="${successMessage}"></span>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger">
            <wa-icon name="exclamation-triangle" style="margin-right: 0.5rem;"></wa-icon>
            <span th:text="${errorMessage}"></span>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="htmx-indicator" style="display: none;">
            <div class="alert alert-info">
                <wa-icon name="clock" style="margin-right: 0.5rem;"></wa-icon>
                Saving journal entry...
            </div>
        </div>

        <!-- Batch Posting Form -->
        <div class="posting-form">
            <div class="form-header">
                <h4 style="margin: 0;">Postings</h4>
                <small class="text-muted">Debits must equal credits</small>
            </div>
            
            <form th:attr="hx-post='/voucher/batch-postings?tenantId=' + ${user.ctx.currentTenant?.id}"
                  method="post"
                  hx-target="#form-messages" 
                  hx-swap="innerHTML"
                  hx-indicator="#loading-indicator"
                  id="batchPostingForm" 
                  onsubmit="event.preventDefault(); return validateAndPrepareForm(event);">
                
                <!-- Individual Posting Lines Table -->
                <table class="posting-table">
                    <thead>
                        <tr>
                            <th style="width: 90px;">Date</th>
                            <th style="width: 160px;">Debit (+)</th>
                            <th style="width: 160px;">Credit (-)</th>
                            <th style="width: 100px;">Amount</th>
                            <th style="width: 70px;">Currency</th>
                            <th>Description</th>
                            <th style="width: 60px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="postingLines">
                        <!-- Entries will be added dynamically -->
                    </tbody>
                    <tfoot>
                        <tr class="balance-row">
                            <td></td>
                            <td class="balance-total"><span id="totalDebit">0.00</span></td>
                            <td class="balance-total"><span id="totalCredit">0.00</span></td>
                            <td class="balance-total"><span id="balanceAmount">0.00</span></td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>

                <!-- Form Actions -->
                <div class="form-actions">
                    <wa-button type="button" size="small" variant="neutral" onclick="addPostingLine()">
                        <wa-icon name="plus"></wa-icon>
                        New row
                    </wa-button>
                    
                    <wa-button type="submit" size="small" variant="success" id="saveButton" disabled>
                        Save Postings
                    </wa-button>
                </div>
            </form>
        </div>


    </div>
</main>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Accounts data for search
        const accounts = /*[[${accounts}]]*/ [];
        const vatCodes = /*[[${vatCodes}]]*/ [];
        const companyCurrency = /*[[${companyCurrency}]]*/ 'NOK';
        const supportedCurrencies = /*[[${supportedCurrencies}]]*/ ['NOK', 'USD', 'EUR'];
        let rowCounter = 0;
        
        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            addPostingLine();
        });
        
        function addPostingLine() {
            const tbody = document.getElementById('postingLines');
            const row = document.createElement('tr');
            row.className = 'posting-line-row';
            row.id = 'posting-line-row-' + rowCounter;
            
            const currencyOptions = supportedCurrencies.map(currency => 
                `<option value="${currency}" ${currency === companyCurrency ? 'selected' : ''}>${currency}</option>`
            ).join('');
            
            row.innerHTML = `
                <td>
                    <input type="date" 
                           name="postingLines[${rowCounter}].postingDate" 
                           value="${new Date().toISOString().split('T')[0]}"
                           onchange="validatePostingLineFields(${rowCounter})"
                           required>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <div class="account-search">
                            <input type="text" 
                                   name="postingLines[${rowCounter}].debitAccount" 
                                   placeholder="Search debit account..." 
                                   autocomplete="off"
                                   onkeyup="searchAccounts(this, ${rowCounter}, 'debit')"
                                   onfocus="searchAccounts(this, ${rowCounter}, 'debit')"
                                   onblur="validatePostingLineFields(${rowCounter})"
                                   oninput="toggleAccountSelection(${rowCounter}, 'debit')"
                                   style="font-size: 0.8rem;">
                            <div id="debit-dropdown-${rowCounter}" class="account-dropdown"></div>
                        </div>
                        <div class="vat-search" style="position: relative;">
                            <input type="text" 
                                   name="postingLines[${rowCounter}].debitVatCode" 
                                   placeholder="Type or click to select VAT..." 
                                   autocomplete="off"
                                   onclick="handleVatFieldClick(this, ${rowCounter}, 'debit')"
                                   onfocus="handleVatFieldFocus(this, ${rowCounter}, 'debit')"
                                   onkeyup="handleVatFieldKeyup(this, ${rowCounter}, 'debit')"
                                   onblur="handleVatFieldBlur(this, ${rowCounter}, 'debit')"
                                   class="vat-field">
                            <div id="debit-vat-dropdown-${rowCounter}" class="account-dropdown"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <div class="account-search">
                            <input type="text" 
                                   name="postingLines[${rowCounter}].creditAccount" 
                                   placeholder="Search credit account..." 
                                   autocomplete="off"
                                   onkeyup="searchAccounts(this, ${rowCounter}, 'credit')"
                                   onfocus="searchAccounts(this, ${rowCounter}, 'credit')"
                                   onblur="validatePostingLineFields(${rowCounter})"
                                   oninput="toggleAccountSelection(${rowCounter}, 'credit')"
                                   style="font-size: 0.8rem;">
                            <div id="credit-dropdown-${rowCounter}" class="account-dropdown"></div>
                        </div>
                        <div class="vat-search" style="position: relative;">
                            <input type="text" 
                                   name="postingLines[${rowCounter}].creditVatCode" 
                                   placeholder="Type or click to select VAT..." 
                                   autocomplete="off"
                                   onclick="handleVatFieldClick(this, ${rowCounter}, 'credit')"
                                   onfocus="handleVatFieldFocus(this, ${rowCounter}, 'credit')"
                                   onkeyup="handleVatFieldKeyup(this, ${rowCounter}, 'credit')"
                                   onblur="handleVatFieldBlur(this, ${rowCounter}, 'credit')"
                                   class="vat-field">
                            <div id="credit-vat-dropdown-${rowCounter}" class="account-dropdown"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="number" 
                           step="0.01" 
                           name="postingLines[${rowCounter}].amount" 
                           class="amount-input"
                           placeholder="0.00"
                           onchange="handleAmountChange(${rowCounter})"
                           onblur="validatePostingLineFields(${rowCounter})"
                           required>
                    <div id="converted-amount-${rowCounter}" class="converted-amount" style="font-size: 0.7rem; color: #6b7280; margin-top: 2px;"></div>
                </td>
                <td>
                    <select name="postingLines[${rowCounter}].currency" 
                            class="currency-select"
                            onchange="handleCurrencyChange(${rowCounter})">
                        ${currencyOptions}
                    </select>
                </td>
                <td>
                    <input type="text" 
                           name="postingLines[${rowCounter}].description" 
                           placeholder="Description">
                </td>
                <td>
                    <wa-button type="button" size="small" variant="danger" onclick="removePostingLine(${rowCounter})">
                        <wa-icon name="trash"></wa-icon>
                    </wa-button>
                </td>
            `;
            
            tbody.appendChild(row);
            rowCounter++;
            updateBalance();
        }
        
        function removePostingLine(id) {
            const rows = document.querySelectorAll('.posting-line-row');
            if (rows.length > 1) {
                document.getElementById('posting-line-row-' + id).remove();
                updateBalance();
            }
        }
        
        function validatePostingLineFields(rowId) {
            const dateInput = document.querySelector(`input[name="postingLines[${rowId}].postingDate"]`);
            const debitInput = document.querySelector(`input[name="postingLines[${rowId}].debitAccount"]`);
            const creditInput = document.querySelector(`input[name="postingLines[${rowId}].creditAccount"]`);
            const amountInput = document.querySelector(`input[name="postingLines[${rowId}].amount"]`);
            
            // Clear previous error states
            [dateInput, debitInput, creditInput, amountInput].forEach(input => {
                if (input) input.classList.remove('field-error');
            });
            
            const hasDate = dateInput && dateInput.value.trim() !== '';
            const hasDebitAccount = debitInput && debitInput.value.trim() !== '';
            const hasCreditAccount = creditInput && creditInput.value.trim() !== '';
            const hasAmount = amountInput && amountInput.value && parseFloat(amountInput.value) > 0;
            
            // If any field has data, validate the entire row
            if (hasDate || hasDebitAccount || hasCreditAccount || hasAmount) {
                if (!hasDate) {
                    dateInput.classList.add('field-error');
                }
                
                // Must have at least one account (debit or credit, or both)
                if (!hasDebitAccount && !hasCreditAccount) {
                    debitInput.classList.add('field-error');
                    creditInput.classList.add('field-error');
                }
                
                if (!hasAmount) {
                    amountInput.classList.add('field-error');
                }
            }
        }
        
        function updateBalance() {
            let totalDebit = 0;
            let totalCredit = 0;
            let hasValidEntries = false;
            
            // Calculate totals from individual posting lines using converted amounts
            document.querySelectorAll('.posting-line-row').forEach((row, index) => {
                const amountInput = row.querySelector('input[name*=".amount"]');
                const debitInput = row.querySelector('input[name*=".debitAccount"]');
                const creditInput = row.querySelector('input[name*=".creditAccount"]');
                const dateInput = row.querySelector('input[name*=".postingDate"]');
                const currencySelect = row.querySelector('select[name*=".currency"]');
                
                if (amountInput && amountInput.value && dateInput && dateInput.value) {
                    const originalAmount = parseFloat(amountInput.value);
                    const currency = currencySelect ? currencySelect.value : companyCurrency;
                    
                    // Use converted amount if available, otherwise use original amount
                    const convertedAmountStr = amountInput.getAttribute('data-converted-amount');
                    const convertedAmount = convertedAmountStr ? parseFloat(convertedAmountStr) : originalAmount;

                    if (!isNaN(convertedAmount) && convertedAmount > 0) {
                        const hasDebit = debitInput && debitInput.value.trim() !== '';
                        const hasCredit = creditInput && creditInput.value.trim() !== '';
                        
                        if (hasDebit && hasCredit) {
                            // Both debit and credit filled - this line is self-balanced
                            totalDebit += convertedAmount;
                            totalCredit += convertedAmount;
                            hasValidEntries = true;
                        } else if (hasDebit) {
                            // Only debit filled
                            totalDebit += convertedAmount;
                            hasValidEntries = true;
                        } else if (hasCredit) {
                            // Only credit filled
                            totalCredit += convertedAmount;
                            hasValidEntries = true;
                        }
                    }
                }
            });
            
            const balance = totalDebit - totalCredit;
            const isBalanced = Math.abs(balance) < 0.01;

            // Update display (show amounts in company currency)
            document.getElementById('totalDebit').textContent = totalDebit.toFixed(2) + ' ' + companyCurrency;
            document.getElementById('totalCredit').textContent = totalCredit.toFixed(2) + ' ' + companyCurrency;
            document.getElementById('balanceAmount').textContent = balance.toFixed(2) + ' ' + companyCurrency;
            
            const saveButton = document.getElementById('saveButton');
            const totalDebitElement = document.getElementById('totalDebit');
            const totalCreditElement = document.getElementById('totalCredit');
            const balanceAmountElement = document.getElementById('balanceAmount');
            
            if (isBalanced && hasValidEntries && totalDebit > 0) {
                balanceAmountElement.className = 'balance-success';
                totalDebitElement.className = 'balance-success';
                totalCreditElement.className = 'balance-success';
                saveButton.disabled = false;
            } else {
                balanceAmountElement.className = 'balance-error';
                totalDebitElement.className = 'balance-success';
                totalCreditElement.className = 'balance-success';
                saveButton.disabled = true;
            }
        }
        
        // Handle amount changes with proper async/await
        async function handleAmountChange(rowId) {
            await updateConvertedAmount(rowId);
            updateBalance();
        }
        
        // Handle currency changes with proper async/await
        async function handleCurrencyChange(rowId) {
            await updateConvertedAmount(rowId);
            updateBalance();
        }
        
        // Update converted amount display
        async function updateConvertedAmount(rowId) {
            const amountInput = document.querySelector(`input[name="postingLines[${rowId}].amount"]`);
            const currencySelect = document.querySelector(`select[name="postingLines[${rowId}].currency"]`);
            const convertedAmountDiv = document.getElementById(`converted-amount-${rowId}`);
            
            if (amountInput && currencySelect && convertedAmountDiv) {
                const amount = parseFloat(amountInput.value);
                const currency = currencySelect.value;

                if (!isNaN(amount) && amount > 0 && currency !== companyCurrency) {
                    try {
                        const response = await fetch(`/api/currency/convert?amount=${amount}&fromCurrency=${currency}&toCurrency=${companyCurrency}`);
                        if (response.ok) {
                            const data = await response.json();
                            const convertedAmount = parseFloat(data.convertedAmount);
                            convertedAmountDiv.textContent = `≈ ${convertedAmount.toFixed(2)} ${companyCurrency}`;
                            
                            // Store the converted amount for balance calculation
                            amountInput.setAttribute('data-converted-amount', convertedAmount.toString());
                        } else {
                            console.error('Failed to convert currency, using original amount');
                            convertedAmountDiv.textContent = `≈ ${amount.toFixed(2)} ${companyCurrency}`;
                            amountInput.setAttribute('data-converted-amount', amount.toString());
                        }
                    } catch (error) {
                        console.error('Error converting amount:', error);
                        convertedAmountDiv.textContent = `≈ ${amount.toFixed(2)} ${companyCurrency}`;
                        amountInput.setAttribute('data-converted-amount', amount.toString());
                    }
                } else if (!isNaN(amount) && amount > 0) {
                    // Same currency, no conversion needed
                    convertedAmountDiv.textContent = '';
                    amountInput.setAttribute('data-converted-amount', amount.toString());
                } else {
                    // Invalid amount
                    convertedAmountDiv.textContent = '';
                    amountInput.removeAttribute('data-converted-amount');
                }
            }
        }
        
        function toggleAccountSelection(rowId, type) {
            const debitInput = document.querySelector(`input[name="postingLines[${rowId}].debitAccount"]`);
            const creditInput = document.querySelector(`input[name="postingLines[${rowId}].creditAccount"]`);
            const debitVatInput = document.querySelector(`input[name="postingLines[${rowId}].debitVatCode"]`);
            const creditVatInput = document.querySelector(`input[name="postingLines[${rowId}].creditVatCode"]`);
            
            // Allow both debit and credit to be filled - no disabling logic needed
            // VAT inputs remain enabled for their respective sides
            
            validatePostingLineFields(rowId);
            updateBalance();
        }
        
        function searchAccounts(input, rowId, type) {
            const query = input.value.toLowerCase();
            const dropdown = document.getElementById(type + '-dropdown-' + rowId);
            
            if (query.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            const filteredAccounts = accounts.filter(account => 
                account.noAccountNumber.includes(query) ||
                account.accountName.toLowerCase().includes(query) ||
                account.accountDescription.toLowerCase().includes(query)
            );
            
            if (filteredAccounts.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = filteredAccounts.map(account => `
                <div class="account-item" onclick="selectAccount('${account.noAccountNumber}', '${account.accountName}', ${rowId}, '${type}')">
                        <div style="font-weight: 500;">${account.noAccountNumber}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${account.accountName}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectAccount(accountNumber, accountName, rowId, type) {
            const input = document.querySelector(`input[name="postingLines[${rowId}].${type}Account"]`);
            input.value = accountNumber;
            document.getElementById(type + '-dropdown-' + rowId).style.display = 'none';
            
            // Trigger toggle function to disable the other input
            toggleAccountSelection(rowId, type);
        }
        
        function searchVatCodes(input, rowId, type) {
            const query = input.value.toLowerCase();
            const dropdown = document.getElementById(type + '-vat-dropdown-' + rowId);
            
            // Show all VAT codes when field is focused or query is empty
            let filteredVatCodes;
            if (query.length === 0) {
                filteredVatCodes = vatCodes;
            } else {
                filteredVatCodes = vatCodes.filter(vatCode => 
                    vatCode.code.toLowerCase().includes(query) ||
                    vatCode.description.toLowerCase().includes(query) ||
                    vatCode.rate.toString().includes(query) ||
                    vatCode.vatType.toLowerCase().includes(query) ||
                    vatCode.vatCategory.toLowerCase().includes(query)
                );
            }
            
            if (filteredVatCodes.length === 0) {
                dropdown.innerHTML = `
                    <div class="account-item" style="color: #9ca3af; font-style: italic;">
                        <div style="font-size: 0.8rem;">No VAT codes found</div>
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = filteredVatCodes.map(vatCode => `
                <div class="account-item" onclick="selectVatCode('${vatCode.code}', '${vatCode.description}', ${rowId}, '${type}')">
                        <div style="font-weight: 500; font-size: 0.8rem;">${vatCode.code} - ${vatCode.rate}% (${vatCode.vatCategory})</div>
                        <div style="font-size: 0.7rem; color: #6b7280;">${vatCode.description}</div>
                        <div style="font-size: 0.65rem; color: #9ca3af;">${vatCode.vatType}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectVatCode(vatCode, description, rowId, type) {
            const input = document.querySelector(`input[name="postingLines[${rowId}].${type}VatCode"]`);
            const vatCodeObj = vatCodes.find(vc => vc.code === vatCode);
            
            // Display the code with rate for better UX
            if (vatCodeObj) {
                input.value = `${vatCode} (${vatCodeObj.rate}%)`;
                input.setAttribute('data-vat-code', vatCode); // Store actual code for form submission
            } else {
                input.value = vatCode;
                input.setAttribute('data-vat-code', vatCode);
            }
            
            document.getElementById(type + '-vat-dropdown-' + rowId).style.display = 'none';
        }
        
        function showAllVatCodes(input, rowId, type) {
            // Clear the search and show all codes
            input.value = '';
            searchVatCodes(input, rowId, type);
        }
        
        // Enhanced VAT field handlers
        function handleVatFieldClick(input, rowId, type) {
            // If field is empty or contains display value, show all VAT codes
            if (!input.value || input.value.includes('(') || input.value.includes('%')) {
                input.value = '';
                input.removeAttribute('data-vat-code');
                searchVatCodes(input, rowId, type);
            }
        }
        
        function handleVatFieldFocus(input, rowId, type) {
            // Show dropdown when focused
            if (!input.value) {
                searchVatCodes(input, rowId, type);
            }
        }
        
        function handleVatFieldKeyup(input, rowId, type) {
            // Clear data attribute when user types
            input.removeAttribute('data-vat-code');
            searchVatCodes(input, rowId, type);
        }
        
        function handleVatFieldBlur(input, rowId, type) {
            // Delay hiding dropdown to allow click on items
            setTimeout(() => {
                const dropdown = document.getElementById(type + '-vat-dropdown-' + rowId);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 150);
        }
        
        // Hide dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.account-search') && !e.target.closest('.vat-search')) {
                document.querySelectorAll('.account-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        

        
        // Frontend validation functions
        function validateField(fieldId, value, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorSpan = document.getElementById(fieldId + '-error');
            
            if (!value || value.trim() === '') {
                field.classList.add('field-error');
                errorSpan.textContent = errorMessage;
                errorSpan.style.display = 'block';
                return false;
            } else {
                field.classList.remove('field-error');
                errorSpan.style.display = 'none';
                return true;
            }
        }
        
        function validateFormFields() {
            let isValid = true;
            
            // Validate posting lines
            const rows = document.querySelectorAll('.posting-line-row');
            let hasValidEntries = false;
            
            rows.forEach((row, index) => {
                const dateInput = row.querySelector('input[name*=".postingDate"]');
                const debitInput = row.querySelector('input[name*=".debitAccount"]');
                const creditInput = row.querySelector('input[name*=".creditAccount"]');
                const amountInput = row.querySelector('input[name*=".amount"]');
                
                // Clear previous errors
                [dateInput, debitInput, creditInput, amountInput].forEach(input => {
                    if (input) input.classList.remove('field-error');
                });
                
                const hasDate = dateInput && dateInput.value.trim() !== '';
                const hasDebitAccount = debitInput && debitInput.value.trim() !== '';
                const hasCreditAccount = creditInput && creditInput.value.trim() !== '';
                const hasAmount = amountInput && amountInput.value && parseFloat(amountInput.value) > 0;
                
                if (hasDate || hasDebitAccount || hasCreditAccount || hasAmount) {
                    // This row has some data, validate it completely
                    if (!hasDate) {
                        dateInput.classList.add('field-error');
                        isValid = false;
                    }
                    
                    // Must have at least one account (debit or credit, or both)
                    if (!hasDebitAccount && !hasCreditAccount) {
                        debitInput.classList.add('field-error');
                        creditInput.classList.add('field-error');
                        isValid = false;
                    }
                    
                    if (!hasAmount) {
                        amountInput.classList.add('field-error');
                        isValid = false;
                    }
                    
                    if (hasDate && (hasDebitAccount || hasCreditAccount) && hasAmount) {
                        hasValidEntries = true;
                    }
                }
            });
            
            if (!hasValidEntries) {
                showMessage('Please add at least one complete posting line.', 'error');
                isValid = false;
            }
            
            return isValid;
        }
        
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('form-messages');
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const iconName = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            messagesDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <wa-icon name="${iconName}" style="margin-right: 0.5rem;"></wa-icon>
                    ${message}
                </div>
            `;
        }
        
        // Combined validation and form preparation
        async function validateAndPrepareForm(event) {
            // First validate all fields
            if (!validateFormFields()) {
                return false;
            }
            
            // Then prepare form data
            return await prepareFormData(event);
        }
        
        // Prepare form data before submission
        async function prepareFormData(event) {

            // First, make sure all conversions are up to date
            const rows = Array.from(document.querySelectorAll('.posting-line-row'));
            
            // Update all conversions before validating
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowId = row.id.replace('posting-line-row-', '');
                const amountInput = row.querySelector('input[name*=".amount"]');
                const currencySelect = row.querySelector('select[name*=".currency"]');
                
                if (amountInput && amountInput.value && currencySelect && currencySelect.value) {
                    await updateConvertedAmount(rowId);
                }
            }
            
            // Now validate the balance
            updateBalance();
            
            // Remove empty rows and reindex
            const tbody = document.getElementById('postingLines');
            const allRows = Array.from(tbody.querySelectorAll('.posting-line-row'));
            
            // Filter out empty rows and prepare posting lines
            const validPostingLines = [];
            
            allRows.forEach(row => {
                const dateInput = row.querySelector('input[name*=".postingDate"]');
                const debitInput = row.querySelector('input[name*=".debitAccount"]');
                const creditInput = row.querySelector('input[name*=".creditAccount"]');
                const amountInput = row.querySelector('input[name*=".amount"]');
                const currencySelect = row.querySelector('select[name*=".currency"]');
                const descriptionInput = row.querySelector('input[name*=".description"]');
                const debitVatInput = row.querySelector('input[name*=".debitVatCode"]');
                const creditVatInput = row.querySelector('input[name*=".creditVatCode"]');
                
                const hasDate = dateInput && dateInput.value.trim() !== '';
                const hasDebitAccount = debitInput && debitInput.value.trim() !== '';
                const hasCreditAccount = creditInput && creditInput.value.trim() !== '';
                const hasAmount = amountInput && amountInput.value && parseFloat(amountInput.value) > 0;
                
                if (hasDate && (hasDebitAccount || hasCreditAccount) && hasAmount) {
                    const baseData = {
                        postingDate: dateInput.value,
                        amount: amountInput.value,
                        currency: currencySelect.value,
                        description: descriptionInput ? descriptionInput.value : ''
                    };
                    
                    // Always create one posting line with both debit and credit accounts (backend will handle splitting)
                    validPostingLines.push({
                        ...baseData,
                        debitAccount: hasDebitAccount ? debitInput.value : '',
                        creditAccount: hasCreditAccount ? creditInput.value : '',
                        debitVatCode: hasDebitAccount ? getActualVatCode(debitVatInput) : '',
                        creditVatCode: hasCreditAccount ? getActualVatCode(creditVatInput) : ''
                    });
                }
            });

            // Check balance before submission - use the same logic as backend
            let totalSignedAmount = 0;
            
            validPostingLines.forEach(line => {
                const amount = parseFloat(line.amount);
                const hasDebit = line.debitAccount.trim() !== '';
                const hasCredit = line.creditAccount.trim() !== '';
                
                if (hasDebit && hasCredit) {
                    // Both sides filled - this line is balanced (backend will create +amount and -amount)
                    // No contribution to total (0)
                } else if (hasDebit) {
                    // Only debit - positive contribution
                    totalSignedAmount += amount;
                } else if (hasCredit) {
                    // Only credit - negative contribution
                    totalSignedAmount -= amount;
                }
            });

            if (Math.abs(totalSignedAmount) >= 0.01) {
                alert(`Transaction is not balanced! Total signed amount: ${totalSignedAmount.toFixed(2)} ${companyCurrency}`);
                return false;
            }
            
            // Remove all rows
            allRows.forEach(row => row.remove());
            
            // Create new rows from validPostingLines
            validPostingLines.forEach((line, index) => {
                const newRow = document.createElement('tr');
                newRow.className = 'posting-line-row';
                newRow.innerHTML = `
                    <input type="hidden" name="postingLines[${index}].postingDate" value="${line.postingDate}">
                    <input type="hidden" name="postingLines[${index}].debitAccount" value="${line.debitAccount || ''}">
                    <input type="hidden" name="postingLines[${index}].creditAccount" value="${line.creditAccount || ''}">
                    <input type="hidden" name="postingLines[${index}].amount" value="${line.amount}">
                    <input type="hidden" name="postingLines[${index}].currency" value="${line.currency}">
                    <input type="hidden" name="postingLines[${index}].description" value="${line.description || ''}">
                    <input type="hidden" name="postingLines[${index}].debitVatCode" value="${line.debitVatCode || ''}">
                    <input type="hidden" name="postingLines[${index}].creditVatCode" value="${line.creditVatCode || ''}">
                `;
                tbody.appendChild(newRow);
            });
            
            // If no valid posting lines, prevent form submission
            if (validPostingLines.length === 0) {
                alert('Please add at least one complete posting line.');
                return false;
            }
            
            return true;
        }
        
        function getActualVatCode(vatInput) {
            if (!vatInput || !vatInput.value) return '';
            
            const actualCode = vatInput.getAttribute('data-vat-code');
            if (actualCode) {
                return actualCode;
            } else if (vatInput.value.includes('(')) {
                // Extract code from display value like "1 (25%)"
                const codeMatch = vatInput.value.match(/^(\w+)\s*\(/);
                if (codeMatch) {
                    return codeMatch[1];
                }
            }
            return vatInput.value;
        }
    </script>
</th:block>
</body>
</html> 
