<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <link rel="stylesheet" th:href="@{/assets/voucher/advanced-voucher.css}">

    <!-- r-combobox dependencies -->
    <th:block th:replace="~{fragments/r-combobox :: r-combobox-dependencies}"></th:block>
</head>

<!-- Breadcrumb Items -->
<th:block layout:fragment="breadcrumb-items">
    <wa-breadcrumb-item th:href="'/voucher/overview?tenantId=' + ${user.ctx.currentTenant?.id}">
        Vouchers
    </wa-breadcrumb-item>
    <wa-breadcrumb-item>
        Advanced Voucher
    </wa-breadcrumb-item>
</th:block>

<body>
<main layout:fragment="content">
    <div class="container py-4">

                <!-- Messages will be displayed via the base template callout system -->
        <div id="form-messages">
            <!-- This div is kept for HTMX target, but messages will be displayed in base template -->
        </div>

        <div id="loading-indicator" class="htmx-indicator" style="display: none;">
            <div class="alert alert-info">
                <wa-icon name="clock" style="margin-right: 0.5rem;"></wa-icon>
                Saving voucher...
            </div>
        </div>

        <!-- Complete Voucher Form -->
        <form th:attr="hx-post='/htmx/voucher/create?tenantId=' + ${user.ctx.currentTenant?.id}"
              hx-target="#form-messages"
              hx-indicator="#loading-indicator"
              id="voucherForm"
              onsubmit="return validateAndPrepareForm(event);">

            <!-- Voucher Information Card -->
            <div class="posting-form mb-4">
                <div class="form-header">
                    <h4 style="margin: 0;" th:text="#{voucher_information}" />
                    <wa-button th:text="#{voucher_upload_files}"/>
                </div>

                <div class="wa-stack">
                    <div>
                        <label for="voucherDate" class="form-label">Date <span class="text-danger">*</span></label>
                        <wa-input size="small" type="date"
                               class="form-control"
                               id="voucherDate"
                               name="voucherDate"
                               th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                  required></wa-input>
                    </div>
                    <div>
                        <label for="voucherDescription" class="form-label" th:text="#{description}" />
                        <wa-input size="small" type="text"
                               class="form-control"
                               id="voucherDescription"
                               name="voucherDescription"
                                  placeholder="Optional voucher description"></wa-input>
                    </div>
                </div>
            </div>

            <!-- Postings Card -->
            <div class="posting-form">
                <div class="form-header">
                    <h4 style="margin: 0;" th:text="#{postings}" />
                    <small class="text-muted" th:text="#{debits.credits}" />
                </div>

                <!-- Individual Posting Lines Table -->
                <table class="posting-table">
                    <thead>
                        <tr>
                            <th th:text="#{date}" style="width: 90px;" />
                            <th th:text="#{debit}" style="width: 160px;" />
                            <th th:text="#{credit}" style="width: 160px;" />
                            <th th:text="#{amount}" style="width: 100px;" />
                            <th th:text="#{currency}" style="width: 70px;" />
                            <th th:text="#{description}" />
                            <th th:text="#{action}" style="width: 60px;" />
                        </tr>
                    </thead>
                    <tbody id="postingLines">
                        <!-- Initial posting line will be added via HTMX on page load -->
                    </tbody>
                    <tfoot id="balanceFooter">
                        <tr class="balance-row">
                            <td></td>
                            <td class="balance-total"><span id="totalDebit">0.00 NOK</span></td>
                            <td class="balance-total"><span id="totalCredit">0.00 NOK</span></td>
                            <td class="balance-total"><span id="balanceAmount">0.00 NOK</span></td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>

                <!-- Form Actions -->
                <div class="form-actions">
                    <wa-button type="button" 
                               size="small" 
                               variant="neutral"
                               onclick="addPostingLine()">
                        New row
                    </wa-button>
                    
                    <wa-button type="submit" size="small" variant="success" id="saveButton">
                        Create
                    </wa-button>
                </div>
            </div>
        </form>


    </div>
</main>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Clear form if success flag is set
        const clearForm = /*[[${clearForm ?: false}]]*/ false;
    </script>

    <script th:src="@{/assets/voucher/advanced-voucher.js}"></script>
</th:block>
</body>
</html> 
