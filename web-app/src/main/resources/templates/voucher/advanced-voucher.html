<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <link rel="stylesheet" th:href="@{/assets/voucher/advanced-voucher.css}">
</head>

<!-- Breadcrumb Items -->
<th:block layout:fragment="breadcrumb-items">
    <wa-breadcrumb-item th:href="'/voucher/overview?tenantId=' + ${user.ctx.currentTenant?.id}">
        Vouchers
    </wa-breadcrumb-item>
    <wa-breadcrumb-item>
        Advanced Voucher
    </wa-breadcrumb-item>
</th:block>

<body>
<main layout:fragment="content">
    <div class="container py-4">

                <!-- Messages will be displayed via the base template callout system -->
        <div id="form-messages">
            <!-- This div is kept for HTMX target, but messages will be displayed in base template -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="htmx-indicator" style="display: none;">
            <div class="alert alert-info">
                <wa-icon name="clock" style="margin-right: 0.5rem;"></wa-icon>
                Saving voucher...
            </div>
        </div>

        <!-- Complete Voucher Form -->
        <form th:attr="hx-post='/htmx/voucher/create?tenantId=' + ${user.ctx.currentTenant?.id}"
              hx-target="#form-messages"
              hx-indicator="#loading-indicator"
              id="voucherForm" 
              onsubmit="return validateAndPrepareForm(event);">

            <!-- Voucher Information Card -->
            <div class="posting-form mb-4">
                <div class="form-header">
                    <h4 style="margin: 0;">Voucher Information</h4>
                    <small class="text-muted">Basic voucher details</small>
                </div>
                
                <div class="wa-stack">
                    <div>
                        <label for="voucherDate" class="form-label">Date <span class="text-danger">*</span></label>
                        <wa-input size="small" type="date"
                               class="form-control"
                               id="voucherDate"
                               name="voucherDate"
                               th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                  required></wa-input>
                    </div>
                    <div>
                        <label for="voucherDescription" class="form-label">Description</label>
                        <wa-input size="small" type="text"
                               class="form-control" 
                               id="voucherDescription"
                               name="voucherDescription" 
                                  placeholder="Optional voucher description"></wa-input>
                    </div>
                </div>
            </div>

            <!-- Postings Card -->
            <div class="posting-form">
                <div class="form-header">
                    <h4 style="margin: 0;">Postings</h4>
                    <small class="text-muted">Debits must equal credits</small>
                </div>
                
                <!-- Individual Posting Lines Table -->
                <table class="posting-table">
                    <thead>
                        <tr>
                            <th style="width: 90px;">Date</th>
                            <th style="width: 160px;">Debit (+)</th>
                            <th style="width: 160px;">Credit (-)</th>
                            <th style="width: 100px;">Amount</th>
                            <th style="width: 70px;">Currency</th>
                            <th>Description</th>
                            <th style="width: 60px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="postingLines">
                        <!-- Initial posting line will be added via HTMX on page load -->
                    </tbody>
                    <tfoot id="balanceFooter">
                        <tr class="balance-row">
                            <td></td>
                            <td class="balance-total"><span id="totalDebit">0.00 NOK</span></td>
                            <td class="balance-total"><span id="totalCredit">0.00 NOK</span></td>
                            <td class="balance-total"><span id="balanceAmount">0.00 NOK</span></td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>

                <!-- Form Actions -->
                <div class="form-actions">
                    <wa-button type="button" 
                               size="small" 
                               variant="neutral"
                               onclick="addPostingLine()">
                        New row
                    </wa-button>
                    
                    <wa-button type="submit" size="small" variant="success" id="saveButton">
                        Save Voucher
                    </wa-button>
                </div>
            </div>
        </form>


    </div>
</main>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Clear form if success flag is set
        const clearForm = /*[[${clearForm ?: false}]]*/ false;
    </script>

    <script th:src="@{/assets/voucher/advanced-voucher.js}"></script>
</th:block>
</body>
</html> 
