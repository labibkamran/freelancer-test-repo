<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Create Company</title>
    <style>
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .search-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .search-item:hover {
            background-color: #f8fafc;
        }
        
        .search-item:last-child {
            border-bottom: none;
        }
        
        .search-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .search-item-details {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .loading-spinner {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
        }
    </style>
</head>

<body>
<main layout:fragment="content">
    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    Create New Company
                </h1>
                <p class="text-muted">Fill out your company details or search the Norwegian business registry for automatic completion</p>
            </div>
        </div>

        <div>

            <wa-card style="margin-bottom: 1rem;">
                <div slot="header">
                    <h5 style="margin: 0;">
                        üè¢ Company Information
                    </h5>
                </div>
                <div style="padding: 2rem;">
                    <form id="createCompanyForm">
                        <!-- Company Name Field with Search -->
                        <div class="form-group">
                            <label for="companyName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                Company Name *
                            </label>
                            <wa-input
                                    id="companyName"
                                    name="companyName"
                                    placeholder="Enter company name or search registry..."
                                    size="medium"
                                    required
                                    autocomplete="off">
                            </wa-input>
                            <wa-spinner id="nameSpinner" class="loading-spinner" style="display: none;"></wa-spinner>
                            <div id="nameDropdown" class="search-dropdown"></div>
                        </div>

                        <!-- Organization Number Field with Search -->
                        <div class="form-group">
                            <label for="organizationNumber" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                Organization Number *
                            </label>
                            <wa-input
                                    id="organizationNumber"
                                    name="organizationNumber"
                                    placeholder="Enter organization number..."
                                    size="medium"
                                    required
                                    autocomplete="off">
                            </wa-input>
                            <wa-spinner id="orgSpinner" class="loading-spinner" style="display: none;"></wa-spinner>
                            <div id="orgDropdown" class="search-dropdown"></div>
                        </div>

                        <!-- Country Code Field -->
                        <div class="form-group">
                            <label for="countryCode" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                Country *
                            </label>
                            <wa-select id="countryCode" name="countryCode" value="NO" required>
                                <wa-option value="NO">üá≥üá¥ Norway</wa-option>
                            </wa-select>
                            <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                                Currently, only Norwegian companies are supported
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <wa-button type="submit" variant="success" size="small" id="submitButton">
                                <wa-icon name="plus" style="margin-right: 0.5rem;"></wa-icon>
                                Create Company
                            </wa-button>
                            <wa-button type="button" variant="neutral" size="small" onclick="clearForm()">
                                Clear Form
                            </wa-button>
                        </div>
                    </form>
                </div>
            </wa-card>

            <!-- Help Card -->
            <wa-card>
                <div slot="header">
                    <h5 style="margin: 0;">üí° Tips</h5>
                </div>
                <div style="padding: 1.5rem;">
                    <h6>Smart Search Features:</h6>
                    <ul style="margin-bottom: 1.5rem; padding-left: 1.5rem; line-height: 1.6;">
                        <li>Type in the <strong>Company Name</strong> field to search for companies</li>
                        <li>Enter an <strong>Organization Number</strong> to find exact matches</li>
                        <li>Click on any suggestion to auto-fill the form</li>
                        <li>If not found, you can manually enter the details</li>
                    </ul>

                    <wa-alert variant="primary" open>
                        <wa-icon slot="icon" name="info-circle"></wa-icon>
                        <strong>Registry Search:</strong> Data is fetched from Br√∏nn√∏ysundregistrene in real-time.
                    </wa-alert>

                    <wa-alert variant="warning" open style="margin-top: 1rem;">
                        <wa-icon slot="icon" name="exclamation-triangle"></wa-icon>
                        <strong>Note:</strong> All fields are required to create a company.
                    </wa-alert>
                </div>
            </wa-card>
        </div>
    </div>
</main>

<th:block layout:fragment="scripts">
    <script>
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Global search controllers
        let nameSearchController = null;
        let orgSearchController = null;

        // Company name search
        const companyNameInput = document.getElementById('companyName');
        const nameDropdown = document.getElementById('nameDropdown');
        const nameSpinner = document.getElementById('nameSpinner');

        const debouncedNameSearch = debounce(async (query) => {
            if (query.length < 2) {
                hideDropdown(nameDropdown);
                return;
            }

            // Cancel previous request
            if (nameSearchController) {
                nameSearchController.abort();
            }
            nameSearchController = new AbortController();

            showSpinner(nameSpinner);
            
            try {
                const response = await fetch(`/api/company-lookup/search?query=${encodeURIComponent(query)}&countryCode=NO`, {
                    signal: nameSearchController.signal
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displayNameSearchResults(data.companies.slice(0, 10)); // Limit to 10 results
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Name search error:', error);
                    hideDropdown(nameDropdown);
                }
            } finally {
                hideSpinner(nameSpinner);
            }
        }, 300);

        // Organization number search
        const organizationNumberInput = document.getElementById('organizationNumber');
        const orgDropdown = document.getElementById('orgDropdown');
        const orgSpinner = document.getElementById('orgSpinner');

        const debouncedOrgSearch = debounce(async (query) => {
            if (query.length < 3) {
                hideDropdown(orgDropdown);
                return;
            }

            // Cancel previous request
            if (orgSearchController) {
                orgSearchController.abort();
            }
            orgSearchController = new AbortController();

            showSpinner(orgSpinner);
            
            try {
                const response = await fetch(`/api/company-lookup/search?query=${encodeURIComponent(query)}&countryCode=NO`, {
                    signal: orgSearchController.signal
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                // For org number search, show exact matches or close matches
                const matches = data.companies.filter(company => 
                    company.registrationNumber && 
                    company.registrationNumber.includes(query)
                );
                displayOrgSearchResults(matches.slice(0, 5)); // Limit to 5 for org search
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Org search error:', error);
                    hideDropdown(orgDropdown);
                }
            } finally {
                hideSpinner(orgSpinner);
            }
        }, 300);

        // Event listeners
        companyNameInput.addEventListener('input', (e) => {
            debouncedNameSearch(e.target.value.trim());
        });

        organizationNumberInput.addEventListener('input', (e) => {
            debouncedOrgSearch(e.target.value.trim());
        });

        // Hide dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!nameDropdown.contains(e.target) && !companyNameInput.contains(e.target)) {
                hideDropdown(nameDropdown);
            }
            if (!orgDropdown.contains(e.target) && !organizationNumberInput.contains(e.target)) {
                hideDropdown(orgDropdown);
            }
        });

        // Display search results functions
        function displayNameSearchResults(companies) {
            if (!companies || companies.length === 0) {
                hideDropdown(nameDropdown);
                return;
            }

            const html = companies.map(company => `
                <div class="search-item" onclick="selectCompanyFromNameSearch('${escapeHtml(company.name)}', '${escapeHtml(company.registrationNumber || '')}')">
                    <div class="search-item-name">${escapeHtml(company.name)}</div>
                    <div class="search-item-details">
                        ${company.registrationNumber ? `Org. Nr: ${escapeHtml(company.registrationNumber)}` : ''}
                        ${company.address ? ` ‚Ä¢ ${escapeHtml(company.address)}` : ''}
                    </div>
                </div>
            `).join('');

            nameDropdown.innerHTML = html;
            showDropdown(nameDropdown);
        }

        function displayOrgSearchResults(companies) {
            if (!companies || companies.length === 0) {
                hideDropdown(orgDropdown);
                return;
            }

            const html = companies.map(company => `
                <div class="search-item" onclick="selectCompanyFromOrgSearch('${escapeHtml(company.name)}', '${escapeHtml(company.registrationNumber || '')}')">
                    <div class="search-item-name">${escapeHtml(company.registrationNumber || '')}</div>
                    <div class="search-item-details">
                        ${escapeHtml(company.name)}
                        ${company.address ? ` ‚Ä¢ ${escapeHtml(company.address)}` : ''}
                    </div>
                </div>
            `).join('');

            orgDropdown.innerHTML = html;
            showDropdown(orgDropdown);
        }

        // Selection functions
        function selectCompanyFromNameSearch(name, orgNumber) {
            companyNameInput.value = name;
            if (orgNumber) {
                organizationNumberInput.value = orgNumber;
            }
            hideDropdown(nameDropdown);
            hideDropdown(orgDropdown);
        }

        function selectCompanyFromOrgSearch(name, orgNumber) {
            if (orgNumber) {
                organizationNumberInput.value = orgNumber;
            }
            companyNameInput.value = name;
            hideDropdown(nameDropdown);
            hideDropdown(orgDropdown);
        }

        // Utility functions
        function showSpinner(spinner) {
            spinner.style.display = 'block';
        }

        function hideSpinner(spinner) {
            spinner.style.display = 'none';
        }

        function showDropdown(dropdown) {
            dropdown.style.display = 'block';
        }

        function hideDropdown(dropdown) {
            dropdown.style.display = 'none';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearForm() {
            document.getElementById('createCompanyForm').reset();
            hideDropdown(nameDropdown);
            hideDropdown(orgDropdown);
        }

        // Form submission
        document.getElementById('createCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const submitButton = document.getElementById('submitButton');
            
            const requestData = {
                name: formData.get('companyName').trim(),
                organizationNumber: formData.get('organizationNumber').trim(),
                countryCode: formData.get('countryCode')
            };

            // Validation
            if (!requestData.name || !requestData.organizationNumber) {
                alert('Please fill in all required fields.');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<wa-spinner style="margin-right: 0.5rem;"></wa-spinner> Creating Company...';

            try {
                const response = await fetch('/api/companies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create company');
                }

                const company = await response.json();
                
                // Show success message
                const successAlert = document.createElement('wa-alert');
                successAlert.setAttribute('variant', 'success');
                successAlert.setAttribute('open', '');
                successAlert.innerHTML = `
                    <wa-icon slot="icon" name="check-circle"></wa-icon>
                    <strong>Success!</strong> Company "${company.name}" has been created successfully!
                    <br><small>Redirecting to dashboard...</small>
                `;
                
                e.target.parentNode.insertBefore(successAlert, e.target);
                
                // Redirect to dashboard after delay
                setTimeout(() => {
                    window.location.href = `/dashboard?tenantId=${company.tenantId}`;
                }, 2000);

            } catch (error) {
                console.error('Error creating company:', error);
                
                const errorAlert = document.createElement('wa-alert');
                errorAlert.setAttribute('variant', 'danger');
                errorAlert.setAttribute('open', '');
                errorAlert.innerHTML = `
                    <wa-icon slot="icon" name="exclamation-triangle"></wa-icon>
                    <strong>Error!</strong> Failed to create company: ${error.message}
                `;
                
                e.target.parentNode.insertBefore(errorAlert, e.target);
                
                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = '<wa-icon name="plus" style="margin-right: 0.5rem;"></wa-icon> Create Company';
            }
        });
    </script>
</th:block>
</body>
</html> 